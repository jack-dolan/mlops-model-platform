name: Deploy

on:
  workflow_run:
    workflows: ["Build"]
    types: [completed]
    branches: [main]

env:
  IMAGE: ghcr.io/jack-dolan/mlops-model-platform
  TAG: ${{ github.event.workflow_run.head_sha }}

jobs:
  deploy-staging:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set PATH
        run: echo "/opt/homebrew/bin:/usr/local/bin" >> $GITHUB_PATH

      - name: Deploy to staging
        run: |
          kubectl apply -k kubernetes/overlays/staging
          kubectl set image deployment/model-service model-service=${{ env.IMAGE }}:${{ env.TAG }} -n staging
          kubectl rollout status deployment/model-service -n staging --timeout=300s

      - name: Verify deployment
        run: |
          kubectl wait --for=condition=ready pod -l app=model-service -n staging --timeout=120s
          kubectl exec -n staging deploy/model-service -- python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/health').read().decode())"

      - name: Prune unused images
        run: limactl shell k3s sudo crictl rmi --prune

  deploy-production:
    runs-on: self-hosted
    needs: deploy-staging
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Set PATH
        run: echo "/opt/homebrew/bin:/usr/local/bin" >> $GITHUB_PATH

      - name: Deploy to production
        run: |
          kubectl apply -k kubernetes/overlays/production
          kubectl set image deployment/model-service model-service=${{ env.IMAGE }}:${{ env.TAG }} -n production
          kubectl rollout status deployment/model-service -n production --timeout=300s

      - name: Verify deployment
        run: |
          kubectl wait --for=condition=ready pod -l app=model-service -n production --timeout=120s
          kubectl exec -n production deploy/model-service -- python -c "import urllib.request; print(urllib.request.urlopen('http://localhost:8000/health').read().decode())"

      - name: Prune unused images
        run: limactl shell k3s sudo crictl rmi --prune
